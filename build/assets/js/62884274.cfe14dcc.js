"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8034],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>c});var i=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=i.createContext({}),u=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=u(e.components);return i.createElement(l.Provider,{value:t},e.children)},m="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=u(n),d=o,c=m["".concat(l,".").concat(d)]||m[d]||h[d]||a;return n?i.createElement(c,r(r({ref:t},p),{},{components:n})):i.createElement(c,r({ref:t},p))}));function c(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,r=new Array(a);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:o,r[1]=s;for(var u=2;u<a;u++)r[u]=n[u];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2544:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var i=n(7462),o=(n(7294),n(3905));const a={sidebar_position:2,id:"Azure Lighthouse Setup",title:"Azure Lighthouse Setup",tags:["Guide","Azure","Lighthouse"]},r=void 0,s={unversionedId:"Guides/Azure Lighthouse Setup",id:"Guides/Azure Lighthouse Setup",title:"Azure Lighthouse Setup",description:"This document covers creating a template manually and uploading to a customer directly. Not an Azure Marketplace offering.",source:"@site/docs/Guides/Azure Lighthouse Setup.md",sourceDirName:"Guides",slug:"/Guides/Azure Lighthouse Setup",permalink:"/Guides/Azure Lighthouse Setup",draft:!1,tags:[{label:"Guide",permalink:"/tags/guide"},{label:"Azure",permalink:"/tags/azure"},{label:"Lighthouse",permalink:"/tags/lighthouse"}],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,id:"Azure Lighthouse Setup",title:"Azure Lighthouse Setup",tags:["Guide","Azure","Lighthouse"]},sidebar:"tutorialSidebar",previous:{title:"Guides",permalink:"/category/guides"},next:{title:"Create an Automation Account",permalink:"/Guides/Create an Automation Account"}},l={},u=[{value:"Prerequisites and Notes",id:"prerequisites-and-notes",level:2},{value:"Online Reading",id:"online-reading",level:3},{value:"Training",id:"training",level:3},{value:"Permissions and Roles",id:"permissions-and-roles",level:3},{value:"Azure Lighthouse Deployment",id:"azure-lighthouse-deployment",level:3},{value:"Setup Guidance and Information",id:"setup-guidance-and-information",level:2},{value:"Azure AD",id:"azure-ad",level:3},{value:"Azure Lighthouse Offering",id:"azure-lighthouse-offering",level:3},{value:"ARM Template",id:"arm-template",level:4},{value:"Offering Name",id:"offering-name",level:5},{value:"Description(s)",id:"descriptions",level:5},{value:"Delegation Scope(s)",id:"delegation-scopes",level:5},{value:"Authorizations",id:"authorizations",level:5},{value:"ARM template Example",id:"arm-template-example",level:3},{value:"Implementation steps",id:"implementation-steps",level:2},{value:"Using Lighthouse",id:"using-lighthouse",level:2},{value:"Via the Lighthouse blade",id:"via-the-lighthouse-blade",level:3},{value:"Via the subscriptions blade",id:"via-the-subscriptions-blade",level:3},{value:"Partner Earned Credit (PEC) using PAL",id:"partner-earned-credit-pec-using-pal",level:2}],p={toc:u};function m(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"This document covers creating a template manually and uploading to a customer directly. Not an Azure Marketplace offering.")),(0,o.kt)("h2",{id:"prerequisites-and-notes"},"Prerequisites and Notes"),(0,o.kt)("h3",{id:"online-reading"},"Online Reading"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/lighthouse/overview"},"Microsoft doc - What is Azure Lighthouse?"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/lighthouse/how-to/onboard-customer"},"Microsoft doc - Onboard a customer to Azure Lighthouse"),".")),(0,o.kt)("h3",{id:"training"},"Training"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"From testing I found that many staff Ire over-whelmed or confused initially by the customer resources showing in their own managing tenant, consider setting up Lighthouse for your more technical staff first who can train the others."),(0,o.kt)("li",{parentName:"ul"},"Consider keeping the permissions as simple as possible and only giving access to Lighthouse those who really need it.")),(0,o.kt)("admonition",{title:"Subscription Filter.",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"When you add a new custoemr via Lighthouse, you'll need to amend the filter to show them. I'd highly recommend training staff to use the filter to work with one subscription or customer at a time, save making changes to the wrong client\\customer.")),(0,o.kt)("h3",{id:"permissions-and-roles"},"Permissions and Roles"),(0,o.kt)("admonition",{title:"Azure Roles.",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"There are over 170 roles in Azure, that's a silly amount of trawl through to find the perfect combination to work with. Consider what you look after for your client\\customer and simplify it as much as possible, limiting access to the staff who really need it maybe enough of a security control for you.")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"If you're an MSP there are too many roles to consider, I'd suggest using at the minimum or two groups that assign the ",(0,o.kt)("inlineCode",{parentName:"li"},"Contributor")," role and the ",(0,o.kt)("inlineCode",{parentName:"li"},"Reader")," role seperately. You can use this segregation to seperate those who should look but not touch and those who need to administer and manage."),(0,o.kt)("li",{parentName:"ul"},"PIM elevation works Ill to provide just-in-time access or to require approvers for work that the elevated rights is needed for."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"Managed Services Registration assignment Delete")," Role, should be assigned so the managing tenant can remove their own Lighthouse delegation without asking the customer to do it."),(0,o.kt)("li",{parentName:"ul"},"Contributor is the ",(0,o.kt)("strong",{parentName:"li"},"highest")," role you can assign through Lighthouse.")),(0,o.kt)("h3",{id:"azure-lighthouse-deployment"},"Azure Lighthouse Deployment"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You need separate deployments for each subscription being onboarded, even if you are onboarding subscriptions in the same customer tenant. The same is true for multiple different resourece groups within a single customer."),(0,o.kt)("li",{parentName:"ul"},"To have a valid ARM template\\offering you must have one permanently assigned role, such as Reader."),(0,o.kt)("li",{parentName:"ul"},"Contributor is the ",(0,o.kt)("strong",{parentName:"li"},"highest")," role you can assign through Lighthouse. (Duplicated I know but, this is important!)")),(0,o.kt)("h2",{id:"setup-guidance-and-information"},"Setup Guidance and Information"),(0,o.kt)("h3",{id:"azure-ad"},"Azure AD"),(0,o.kt)("p",null,"Create your groups in Azure AD, these groups will contain the staff members that will need access to the customer\\client via Azure Lighthouse."),(0,o.kt)("p",null,"I'd Suggest something like the below, the groups can be as granular as you like and as numerious as you like."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Azure Lighthouse Contributor."),(0,o.kt)("li",{parentName:"ul"},"Azure Lighthouse Reader.")),(0,o.kt)("admonition",{title:"Role Assignment to staff business roles.",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"I tried initially to setup groups for our finance team, so they'd be able to manage billing hoIver, this didn't seem to work as I expected. The Billing role didn't seem to grant the access I thought it would, probably me not know how to use permissions properly but, consider that it might take a few goes to get it right. I eventually decided they should be using Partner Centre to query billing issues.")),(0,o.kt)("h3",{id:"azure-lighthouse-offering"},"Azure Lighthouse Offering"),(0,o.kt)("h4",{id:"arm-template"},"ARM Template"),(0,o.kt)("p",null,"Below is an outline and suggestion for each relevant configuratble options for the ARM template."),(0,o.kt)("admonition",{title:"On-boarding multiple Subscriptions or Resource Groups for one client\\customer.",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You need separate deployments for each subscription being onboarded, even if you are onboarding subscriptions in the same customer tenant. The same is true for multiple different resourece groups within a single customer.")),(0,o.kt)("h5",{id:"offering-name"},"Offering Name"),(0,o.kt)("p",null,'This will show in your customer tenant so make sure if reads "nicely", I\'d suggest something like the following.'),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Managing Company Name")," Lighthouse Contributor Offer for ",(0,o.kt)("inlineCode",{parentName:"li"},"Customer Name")," - ",(0,o.kt)("inlineCode",{parentName:"li"},"Subscrption or Resource Group Name"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Managing Company Name")," Lighthouse Reader Offer for ",(0,o.kt)("inlineCode",{parentName:"li"},"Customer Name")," - ",(0,o.kt)("inlineCode",{parentName:"li"},"Subscrption or Resource Group Name"),".")),(0,o.kt)("p",null,"Swap out the relevant information above if you use this naming convention."),(0,o.kt)("h5",{id:"descriptions"},"Description(s)"),(0,o.kt)("p",null,"This is also customer facing, my suggestion is below."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Managing Company Name"),"  managed services offer to administer support resources."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Managing Company Name"),"  offer to work on and administer project resources for ",(0,o.kt)("inlineCode",{parentName:"li"},"project or PO number"),".")),(0,o.kt)("h5",{id:"delegation-scopes"},"Delegation Scope(s)"),(0,o.kt)("p",null,"You've got two options, ",(0,o.kt)("inlineCode",{parentName:"p"},"Subscription")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Resource Group"),", fairly self explenatory however, you cannot change these after deployment so make sure you select the right one for your needs."),(0,o.kt)("h5",{id:"authorizations"},"Authorizations"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Principal type"),": Group\n",(0,o.kt)("strong",{parentName:"p"},"Name"),": Select one of the noted groups in section above.\n",(0,o.kt)("strong",{parentName:"p"},"Display Name"),": Do not edit. (Friendly name that shows in customer tenant, will default to the group name) Role: Assign the roles noted against the groups above.\n",(0,o.kt)("strong",{parentName:"p"},"Access Type"),": Permanent."),(0,o.kt)("h3",{id:"arm-template-example"},"ARM template Example"),(0,o.kt)("p",null,"You can ignore the top few lines until you find ",(0,o.kt)("inlineCode",{parentName:"p"},"mspOfferName"),", close to this you'll find your description field. Change the ",(0,o.kt)("inlineCode",{parentName:"p"},"defaultValue:")," information, not the ",(0,o.kt)("inlineCode",{parentName:"p"},"desciption:")," information."),(0,o.kt)("admonition",{title:"Confirming your scope.",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},'"$schema": "https://schema.management.azure.com/schemas/2019-08-01/subscriptionDeploymentTemplate.json#",'),", this line should say subscription or resource deployment template, depending on what you selected.")),(0,o.kt)("p",null,"Similar situation with the ",(0,o.kt)("inlineCode",{parentName:"p"},"mspOfferDescription:")," as well."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'\n"mspOfferName": {\n   "type": "string",\n   "metadata": {\n    "description": "Specify a unique name for your offer"\n   },\n   "defaultValue": "My Company Lighthouse Contributor Offer for Customer Name - Subscription Name "\n  },\n\n  "mspOfferDescription": {\n   "type": "string",\n   "metadata": {\n    "description": "Name of the Managed Service Provider offering"\n   },\n   "defaultValue": "My Company managed services offer to administer support resources."\n  }\n\n')),(0,o.kt)("p",null,"Locate the ",(0,o.kt)("inlineCode",{parentName:"p"},"variables:")," section to define your group and the Azure role assignments."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'managedByTenantId"')," - is your tenant or partner tenant ID."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'"authorizations":')," - Are you Azure Roles assignments."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'"principalId"')," - Is your object in the managing tenant."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'"roleDefinitionId"')," - Is the Azure AD role you've assigned. In the case below, it's ",(0,o.kt)("inlineCode",{parentName:"li"},"Contributor")," and the ",(0,o.kt)("inlineCode",{parentName:"li"},"Managed Services Registration assignment Delete")," roles."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'"principalIdDisplayName"')," - Is your friendly Group name, this will show in your customer tenant, it does not need to match the group name in the managing tenant.")),(0,o.kt)("p",null,"You'll see some of the information repeated for each role you assign to the same object in the manging tenant."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'"variables": {\n  "mspRegistrationName": "[guid(parameters(\'mspOfferName\'))]",\n  "mspAssignmentName": "[guid(parameters(\'mspOfferName\'))]",\n  "managedByTenantId": "Your tenant ID",\n  "authorizations": [\n   {\n    "principalId": "Your object in the managing tenant",\n    "roleDefinitionId": "b24988ac-6180-42a0-ab88-20f7382dd24c",\n    "principalIdDisplayName": "Lighthouse Contributor"\n   },\n   {\n    "principalId": "Your object in the managing tenant",\n    "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46",\n    "principalIdDisplayName": "Lighthouse Contributor"\n   }\n  ]\n },\n')),(0,o.kt)("admonition",{title:"You can edit the JSON template directly!",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"You don't need to always duck back into Azure Lighthouse to create the templates, you can just edit the JSON files if you're comfortable doing so.")),(0,o.kt)("h2",{id:"implementation-steps"},"Implementation steps"),(0,o.kt)("p",null,"Below are the cut down version steps for deploying the product at at high level."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-text"},"Requisites\n\n- Customer tenant IDs. - Requred for command line and Azure Marketplace deployments.\n- Applicable customer Subscription(s) IDs. - Requred for command line and Azure Marketplace deployments.\n- Setup 2 Groups (within Azure AD), with the roles noted: -\n  - Lighthouse Contributor: Contributor, Managed Services Registration assignment Delete Role.\n  - Lighthouse Reader: Reader.\n\nSteps to create the Azure Lighthouse Delegation offering:\n\n1. Navigate to the Azure Lighthouse Blade in managing Azure tenant.\n2. Create a new Arm template, name it appropriately.\n3. Assign the groups created above to the Azure roles available in the Wizard.\n4. Complete the Wizard and download the ARM template.\n\nSetting up the delegation in the Customer Tenant:\n\n1. Login to customer Azure Tenant.\n2. Search Azure for the Service Providers Blade.\n3. Click Add offer, Select Add via template.\n4. Upload the ARM template.\n5. Select the plus symbol next to the new entry in the list.\n6. Click Delegate subscriptions.\n7. Select the subscriptions from the list.\n8. Check the confirmation box at the bottom and click Delegate.\n\nRepeat this for each customer.\n\nBackout Plan\n\nRemove the delegation.\n\nFrom the partner tenant (requires the `Managed Services Registration assignment Delete Role`. )\n\n1. Navigate to the My customers page.\n2. Select Delegations.\n3. Find the delegation you want to remove, then select the trash can icon that appears in its row.\n\nFailing this method, login to the customer tenant with Global Admin Priviliges and \nremove the delegation from the Service Providers blade.\n")),(0,o.kt)("h2",{id:"using-lighthouse"},"Using Lighthouse"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The methods below are 2 direct methods for accessing customers, you'll be able to see their resources in the portal as if they were your own without having to use the two methods below.")),(0,o.kt)("h3",{id:"via-the-lighthouse-blade"},"Via the Lighthouse blade"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Open the Azure Management Portal."),(0,o.kt)("li",{parentName:"ol"},"Search for Azure Lighthouse."),(0,o.kt)("li",{parentName:"ol"},"Click on the Delegations option on the left-hand side, you may need to click manage my customers if you\u2019ve no connections."),(0,o.kt)("li",{parentName:"ol"},"You will then see your list of your customer\u2019s subscriptions that you have access to.")),(0,o.kt)("h3",{id:"via-the-subscriptions-blade"},"Via the subscriptions blade"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"You'll need to show the customer in the subscription fitler first though.")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Open the Azure Management Portal."),(0,o.kt)("li",{parentName:"ol"},"Navigate to the Subscriptions blade."),(0,o.kt)("li",{parentName:"ol"},"The list of subscriptions will also list the customer subscriptions you have access too.")),(0,o.kt)("admonition",{title:"You won't see the the customer subscriptions straight away!",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You need to first enable this in the Subscription filter."),(0,o.kt)("ol",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ol"},"In the Azure portal, Select the Directory + subscriptions or Settings icon in the top right of the page."),(0,o.kt)("li",{parentName:"ol"},"In the Directories + subscriptions settings page, ensure that the Advanced filters toggle is turned off."),(0,o.kt)("li",{parentName:"ol"},"In the Default subscription filter section, select the appropriate directory and subscription.")),(0,o.kt)("p",{parentName:"admonition"},"(If you have been granted access to one or more resource groups, rather than to an entire subscription, select the subscription to which that resource group belongs. You'll then work in the context of that subscription, but will only be able to access the designated resource group(s).")),(0,o.kt)("h2",{id:"partner-earned-credit-pec-using-pal"},"Partner Earned Credit (PEC) using PAL"),(0,o.kt)("p",null,"PAL - Partner Admin link"),(0,o.kt)("p",null,"PAL is how a partner can be recognised by Microsoft for their work in Azure on-behalf-of their customer."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/lighthouse/how-to/partner-earned-credit#associate-your-partner-id-when-you-onboard-new-customers"},"Microsoft doc - Associate your partner ID when you onboard new customers vai Lighthouse"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/partner-center/link-partner-id-for-azure-performance-pal-dpor#link-to-a-partnerid-with-pal"},"Microsoft doc - Link a PartnerID with PAL or DPOR for PAL"))),(0,o.kt)("p",null,"To do this via Lighthouse, in a nutshell."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-authenticate-service-principal-powershell"},"Create a service principal")," user account in your managing tenant."),(0,o.kt)("li",{parentName:"ol"},"Using that service principal account, ",(0,o.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/cost-management-billing/manage/link-partner-id#link-to-a-partner-id"},"link to your Associated Partner ID")," in your managing tenant."),(0,o.kt)("li",{parentName:"ol"},"Include at least one authorization which includes the service principal Account as a user with an Azure built-in role that is eligible for PEC. ")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"This role must be granted as a permanent assignment, not as a just-in-time eligible authorization, in order for PEC to apply.")))}m.isMDXComponent=!0}}]);
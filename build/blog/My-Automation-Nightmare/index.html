<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">My Automation Nightmare | IT Jamm</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/blog/My-Automation-Nightmare"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="keywords" content="IT, blog, Microsoft, Azure, Computers"><meta data-rh="true" property="og:title" content="My Automation Nightmare | IT Jamm"><meta data-rh="true" name="description" content="My Automation Nightmare"><meta data-rh="true" property="og:description" content="My Automation Nightmare"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-01-05T23:52:40.000Z"><meta data-rh="true" property="article:tag" content="Azure,Automation Account,PowerShell,Managed Identities"><link data-rh="true" rel="icon" href="/img/jam-favicon.png"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/blog/My-Automation-Nightmare"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/My-Automation-Nightmare" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/My-Automation-Nightmare" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="IT Jamm RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="IT Jamm Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SYXJ4RP3B9"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SYXJ4RP3B9",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.9bf48418.css">
<link rel="preload" href="/assets/js/runtime~main.b03f485c.js" as="script">
<link rel="preload" href="/assets/js/main.f56dec81.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/jam-logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/jam-logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">IT JAMM</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/Welcome to the Wiki">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a href="https://github.com/ITJamm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/My-Automation-Nightmare">My Automation Nightmare</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/What can you Automate">What can you Automate</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/What is Automation in Azure">What is Automation in Azure?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Azure Permission &amp; Resource Management">Azure Permission &amp; Resource Management</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">My Automation Nightmare</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-01-05T23:52:40.000Z" itemprop="datePublished">January 5, 2023</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">itjamm</span></div></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>How the hell do I automate a script in Azure?!?</p><p>Buckle up, this is probably going to be a long one, hopefully, by the end of it, you&#x27;ll have a good idea of where to start with the problem of automating script in Azure.</p><p>You got a few options here for automating scripts in Azure, <a href="/blog/What is Automation in Azure">check out this post for the other options available to you here</a>,you&#x27;ve got Azure Functions, Logic Apps and Automation accounts. In this case, the scenario is PowerShell scripts and the tool I&#x27;m going to setup is an Automation account.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Document incoming</div><div class="admonitionContent_S0QG"><p>Check out the full tech doc for the Automation Account and my script example in the Docs area of the site. Annoyingly I cannot link it directly becuase of the way Docusarus works (not digging on you but, that is frustrating!).</p><p>Update: The document is still in the works, collecting all my info!</p></div></div><p>I&#x27;ll do more on the other options in later posts.</p><ol><li>Setup the <strong>Resource Group</strong> and <strong>Automation Account</strong>.</li><li>Setup the <strong>Identity for the Automation Account</strong>, this is key to running scripts against Azure Active Directoy and Office 365 resources.</li><li>Create ourselves a <strong>Runbook</strong>, that sits inside the Automation Account.</li><li><strong>Install the</strong> relevant<strong> modules</strong> for the code we want to run.</li><li>Write ourselves a little script.</li><li>Setup <strong>a schedule</strong> for the Runbook.</li></ol><p>Estimated time to completion: 1 hour (probably more than that if you&#x27;re creating the script for the first time!)</p><p>Now, that sounds pretty simple when it&#x27;s written in a small list like the one above eh? I can tell you now that I ran into random issues all over the place and, that 1 hour estimate went straight out the window!</p><p>Step 1 flew by, steps 2, 3 and 4 went by like a flash, I was 15 minutes in and feeling pretty confident with how it was going so far. Considering I&#x27;d suggested doing this process at my day job to demonstrate how easy it can be to set up and the time-saving benefits we could reap once it&#x27;s set up.</p><p>Well, I was in for a surprise.........</p><p>For step 2 in the list, Setup the Identity for the Automation Account, I chose to use a System-assigned Managed Identity, it sounded right up my street for what I needed to do.</p><blockquote><p>The service principal is tied to the lifecycle of that Azure resource. When the Azure resource is deleted, Azure automatically deletes the service principal for you.
By design, only that Azure resource can use this identity to request tokens from Azure AD.
You authorize the managed identity to have access to one or more services.</p><p>Quoted from <a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#managed-identity-types" target="_blank" rel="noopener noreferrer">Microsotft Doc</a>.</p></blockquote><p>Maybe I am just a bit of an idiot on this one because looking back on this, that doesn&#x27;t sound quite right, although the user assigned managed identity also didn&#x27;t sound much different to me either......</p><p>Before I knew it, I&#x27;m at the point of testing my script, I&#x27;ve followed through the Microsoft docs for how to leverage the System-assigned Managed Identity to connect to Exchange Online and feeling fairly confident althoug skeptical as to
how minmal that command actually is.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$tenantDomain</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;mydomain.onmicrosoft.com&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Domain of the tenant the managed identity belongs to </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Connect-ExchangeOnline</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ManagedIdentity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Organization </span><span class="token variable" style="color:#36acaa">$tenantDomain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Lo and behold, that failed. What followed was a 3 hour battle with this thing before I realised that the System-assigned Managed Identity does not allow you to connect to Office 365\Azure out of the box, it&#x27;s designed not to do this.</p><p>What ensued was an uphill battle to assign the Exchange Admin role and API permissions via the command line to the System-assigned Managed Identity. I was just about ready to throw it out the window when I crumbled and deciced to use a service account (added credentials to the Automation Account) to get it up and running</p><p>This was dissappointing on several levels, I really wanted to get this setup to not use any credentials, I guess that is a task for another day now, as for demonstration purposes, it works a treat!</p><p>Anyway, that whole debacle cost me almost a full working day to get my head around, hopefully, my pain works for your gain...a good example of RTFM and don&#x27;t force something to work, there&#x27;s a good chance it&#x27;s not meant too.</p><p>Thanks for reading!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/azure">Azure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/automation-account">Automation Account</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/power-shell">PowerShell</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/managed-identities">Managed Identities</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/What can you Automate"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">What can you Automate</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/Welcome to the Wiki">Knowledge base</a></li></ul></div><div class="col footer__col"><div class="footer__title">Helpful Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://learn.microsoft.com/en-in/docs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Microsoft Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/it_jamm" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ITJamm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 IT Jamm, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b03f485c.js"></script>
<script src="/assets/js/main.f56dec81.js"></script>
</body>
</html>